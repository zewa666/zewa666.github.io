<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Enforted - Handling game state with Aurelia Store | Pragmatic Coder</title>
  <meta name="description" content="Keeping things understandable ... most of the time" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="Pragmatic Coder">

  
  
  

  
  
  <script type="text/javascript">
    var gaProperty = 'UA-61457743-1';
    var disableStr = 'ga-disable-' + gaProperty;
    if (document.cookie.indexOf(disableStr + '=true') > -1) {
      window[disableStr] = true;
    }
    
    function gaOptout() {
      document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
      window[disableStr] = true;
    }
  </script>
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-61457743-1', 'auto');
    ga('set', 'anonymizeIp', true);
    ga('send', 'pageview');

  </script>
  

</head>


<body class="post-template">

  
  <header class="site-head" style="background-image: url(/content/images/2020/01/enforted_logo.png)">
    
</header>
  
  
<main class="content" role="main">
  <article class="post">
    
      <span class="post-meta">
      <time datetime="2020-02-05T06:58:49.000Z" itemprop="datePublished">
          2020-02-05
      </time>
    
    
    | 
    <a href="/tags/aurelia/">aurelia</a>,
    
    <a href="/tags/enforted/">enforted</a>
    
    
</span>
    
    <h1 class="post-title">
      Enforted - Handling game state with Aurelia Store
    </h1>
    <section class="post-content">
      <p>This is the first article of the Enforted series, which is going to introduce you to how the game state is handled by using the Aurelia Store plugin. To see the other articles, hop over to <a href="https://pragmatic-coder.net/enforted-the-beginning/#Enough-talking-what-about-the-technical-part">the intro’s overview</a>.</p>
<h2 id="The-whole-world-of-Enforted-in-a-single-object"><a href="#The-whole-world-of-Enforted-in-a-single-object" class="headerlink" title="The whole world - of Enforted - in a single object"></a>The whole world - of Enforted - in a single object</h2><p>Before we dive into the topic lets have again a quick look at the games’ layout, shall we?</p>
<p><img src="/content/images/2020/01/enforted-overview.png" alt="Overview of the game"></p>
<p>On a quick look, we can see a lot of individual elements such as a tile, buildings, monsters and the player character, the lefthand-side overview panel as well as the central fortress. They’re all stored in individual entities and rendered using straight forward Aurelia data bindings.</p>
<p>Now in a classic MVVM approach, we’d start of creating one or multiple services to host that data. We could start with a <code>BoardService</code> to hold the tiles and buildings, a <code>GameService</code> to keep track of the player’s character and monsters. Last but not least a <code>ResourceService</code> could be the place to store information about how many resources and stats are left. And that would be a fine approach, but with a small issue. I guess you’ve noticed the sad faces, e.g at the upper left of the outer lane. Those are so-called tragedy-tiles that will introduce a random tragic event. By stepping on one of those you’ll see something like in the following screenshot.</p>
<p><img src="/content/images/2020/02/tragedy-dialog.png" alt="The plague of vermins tragedy got activated"></p>
<p>By reading the tragic message, we can infer that our <em>mills</em> - which are tile buildings for the food resource - are going to be set offline for the current round and won’t produce additional <em>food resources</em>. So once we roll our way to the next round, passing the start tile, at this moment we’d need a handle of all the three above mentioned services, so that we can appropriately adapt the new games state. That means three dependencies injected, a bunch of modified arrays/objects and code to verify that setting those new values does not override any previous action.</p>
<p>Now, what if instead, we could express the whole game in a single object? That might look something along these lines:</p>
<figure class="highlight typescript"><figcaption><span>State interface</span><a href="https://github.com/zewa666/enforted/blob/master/src/store/state.ts#L11-L30" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> State &#123;</span><br><span class="line">  tiles: Tile[];</span><br><span class="line">  players: Player[];</span><br><span class="line">  monsters: Monster[];</span><br><span class="line">  fortressBuildings: FortressBuilding[];</span><br><span class="line">  tileBuildings: TileBuilding[];</span><br><span class="line">  lastDiceRoll?: <span class="built_in">number</span>;</span><br><span class="line">  resources: Resources;</span><br><span class="line">  round: <span class="built_in">number</span>;</span><br><span class="line">  stats: Stats;</span><br><span class="line">  activeFortressBuildingConstruction?: AvailableFortressBuildings;</span><br><span class="line">  activeTragedy?: AvailableTragedyEvents;</span><br><span class="line">  activeTragedyParams?: <span class="built_in">any</span>[];</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Setting this to undefined closes the purchase panel</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  purchaseInProgress?: <span class="built_in">string</span>;</span><br><span class="line">  fireFountainsActive: <span class="built_in">boolean</span>;</span><br><span class="line">  gameStarted: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Going further, every dice roll would now create a new unique state of your game, which can be again represented with a modified state object. And if you think about it, essentially the whole game can be expressed as a series of those individual states. That is exactly where the Aurelia Store plugin comes into action.</p>
<h2 id="Structuring-the-project"><a href="#Structuring-the-project" class="headerlink" title="Structuring the project"></a>Structuring the project</h2><p>Since Enforted does not rely on any sort of backend, it’s pretty straight forward to define the initial layout by using the initial state. If you <a href="https://github.com/zewa666/enforted/blob/master/src/store/state.ts" target="_blank" rel="noopener">head over here</a>, you’ll find exactly that. Essentially the player position, starting resources/stats and initial tiles get populated with their types and placement, which also allows customizing the board’s layout. In the code listing below you can see how those 72 fields are placed and initialized.</p>
<figure class="highlight typescript"><figcaption><span>Generating tiles</span><a href="https://github.com/zewa666/enforted/blob/master/src/store/state.ts#L32" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** The boards layout</span></span><br><span class="line"><span class="comment">  21 22 23 24 25 26 27 28 29 30 31</span></span><br><span class="line"><span class="comment">  20 57 58 59 60 61 62 63 64 65 32</span></span><br><span class="line"><span class="comment">  19 56                      66 33</span></span><br><span class="line"><span class="comment">  18 55                      67 34</span></span><br><span class="line"><span class="comment">  17 54                      68 35</span></span><br><span class="line"><span class="comment">  16 53       Fortress       69 36</span></span><br><span class="line"><span class="comment">  15 52                      70 37</span></span><br><span class="line"><span class="comment">  14 51                      71 38</span></span><br><span class="line"><span class="comment">  13 50                      72 39</span></span><br><span class="line"><span class="comment">  12 49 48 47 46 45 44 43 42 41 40</span></span><br><span class="line"><span class="comment">  11 10 09 08 07 06 05 04 03 02 01</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  ...</span><br><span class="line">  tiles: [</span><br><span class="line">      &#123;  <span class="comment">// Tile 01</span></span><br><span class="line">        id: guid(),</span><br><span class="line">        isCorner: <span class="literal">true</span>,</span><br><span class="line">        placement: <span class="string">"bottom"</span>,</span><br><span class="line">        ring: <span class="string">"outer"</span>,</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"start"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// Tiles 02 - 10</span></span><br><span class="line">      ...Array.from&lt;Tile, Partial&lt;Tile&gt;&gt;<span class="function">(<span class="params"><span class="built_in">Array</span>(<span class="params">9</span>), (<span class="params">_, idx</span>) =&gt; (<span class="params">&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        id: guid(<span class="params"></span>),</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        isCorner: <span class="literal">false</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        placement: "bottom",</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        ring: "outer",</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        <span class="keyword">type</span>: "wood",</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">      &#125;</span>)</span>),</span></span><br><span class="line"><span class="function">      // <span class="params">Tile</span> 11</span></span><br><span class="line"><span class="function">      &#123;</span></span><br><span class="line"><span class="function">        <span class="params">id</span>: <span class="params">guid</span><span class="params">()</span>,</span></span><br><span class="line"><span class="function">        <span class="params">isCorner</span>: <span class="params">true</span>,</span></span><br><span class="line"><span class="function">        <span class="params">placement</span>: "<span class="params">bottom</span>",</span></span><br><span class="line"><span class="function">        <span class="params">ring</span>: "<span class="params">outer</span>",</span></span><br><span class="line"><span class="function">        <span class="params">type</span>: "<span class="params">sacred_grounds</span>"</span></span><br><span class="line"><span class="function">      &#125;,</span></span><br><span class="line"><span class="function">      ...</span></span><br><span class="line"><span class="function">  ]</span></span><br><span class="line"><span class="function">  ...</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>I like to keep everything related to state management in a folder <code>store</code> so the state interface and initial state, therefore, are located in <code>/src/store/state.ts</code>. All actions are located in <code>/src/store/actions</code>. Now here might others say to treat actions like spec files and collocate them with the feature they’re related to. I tend to believe though that actions rarely are used in a single feature but across the app, which is why organizing them by type makes more sense for me. This is a personal preference though and in no way meant as a must. </p>
<p>Now that we know where they are located, let’s see how actions get registered. The <a href="https://github.com/zewa666/enforted/blob/master/src/start-screen.ts" target="_blank" rel="noopener">start-screen</a> component makes use of two custom actions which set the initial players position as well as let the game start. Since these actions are of primary interest for this component they get registered in this constructor.</p>
<p>While at it, let’s look at the <code>start</code> method of the component. You’ll notice the use of the stores <a href="https://aurelia.io/docs/plugins/store#piping-multiple-actions-as-one" target="_blank" rel="noopener">piped dispatch</a> feature, which essentially will pump multiple actions in one state change. The benefit with this approach is that you’ll end up with just one new state while all actions are applied at once, thus no unnecessary re-rendering is triggered. Moreover, you’ll see the <code>au.setRoot</code> method call which is the cheap alternative to using the full-blown Aurelia Router.</p>
<figure class="highlight typescript"><figcaption><span>Dispatching piped actions</span><a href="https://github.com/zewa666/enforted/blob/master/src/start-screen.ts#L40-L43" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> StartScreen &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">private</span> start(name: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store.pipe(addPlayer, name).pipe(startGame).dispatch();</span><br><span class="line">    <span class="keyword">this</span>.au.setRoot(<span class="string">"./app"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="The-mother-of-actions-the-dice-roll"><a href="#The-mother-of-actions-the-dice-roll" class="headerlink" title="The mother of actions: the dice roll"></a>The mother of actions: the dice roll</h2><p>Amongst all those actions, <code>rollDice</code> is certainly one of most interest. It’s not only responsible for the player’s advancement on the board but also how monsters progress and fight, active tragedy results get applied as well as resource harvesting and stats calculations. Doing all of that in one action is pretty much overkill and asks for better separation of concerns. Knowing that actions are nothing else than pure functions, we can make use of their composability.</p>
<p>Let’s look at the following example quickly:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> State &#123;</span><br><span class="line">  hello: <span class="built_in">string</span>,</span><br><span class="line">  foo: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHelloTo</span>(<span class="params">state: State, who: <span class="built_in">string</span></span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    hello: who</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fooIs</span>(<span class="params">state: State</span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    foo: <span class="string">"bar"</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Calling the above actions individually would allow us to update the current state one by one to get the resulting:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(sayHelloTo, <span class="string">"world"</span>);</span><br><span class="line">store.dispatch(fooIs);</span><br><span class="line"></span><br><span class="line"><span class="comment">// New state</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   hello: "world",</span></span><br><span class="line"><span class="comment">//   foo: "bar"</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p>As we learned before though, that would require two states to be generated and create unnecessary intermediate steps. We could also pipe multiple actions <code>store.pipe(sayHelloTo, &quot;world&quot;).pipe(fooIs).dispatch()</code> to get the same effect with one iteration. But we could very easily also create a new function which just simply makes use of the previous two.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloAndFoo</span>(<span class="params">state: State, who: <span class="built_in">string</span></span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sayHelloTo(fooIs(state), who);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The benefit with later though is that you could also rewrite the action to make use of <code>foo</code>s result as input for <code>hello</code>, which wouldn’t be possible with the piped approach.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloToFoo</span>(<span class="params">state: State</span>): <span class="title">State</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> whoIsFoo = fooIs(state);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...state,</span><br><span class="line">    foo: whoIsFoo.foo, <span class="comment">// or ...whoIsFoo</span></span><br><span class="line">    hello: sayHelloTo(whoIsFoo, whoIsFoo.foo).hello</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And exactly that is what the roll dice action makes use of. Of course, we don’t need to always merge the full state in function calls but can also use individual parts of the sub-states. So the following is the result of the roll dice action. I’ll annotate every step inside the listing with comments.</p>
<figure class="highlight typescript"><figcaption><span>diceRoll action</span><a href="https://github.com/zewa666/enforted/blob/master/src/store/actions/dice-roll.ts#L9" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// start with the harvesting state of fortress buildings</span></span><br><span class="line"><span class="keyword">return</span> gatherFortressBuilding(&#123;</span><br><span class="line">    <span class="comment">// pass it in the current state</span></span><br><span class="line">    ...state,</span><br><span class="line">    <span class="comment">// plus an override if the new dice roll will result in</span></span><br><span class="line">    <span class="comment">// another round started</span></span><br><span class="line">    activeFortressBuildingConstruction: isNextRound</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : state.activeFortressBuildingConstruction,</span><br><span class="line">    <span class="comment">// depending on whether it's a new round and/or we had the</span></span><br><span class="line">    <span class="comment">// stumbling steps tragedy active (which lasts for three dice rolls)</span></span><br><span class="line">    <span class="comment">// we set the active tragedy</span></span><br><span class="line">    activeTragedy: isNextRound</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : isStumblingStep &amp;&amp; newStumblingSteps === <span class="literal">undefined</span></span><br><span class="line">        ? <span class="literal">undefined</span></span><br><span class="line">        : state.activeTragedy,</span><br><span class="line">    <span class="comment">// along with it's params, like how many stumblings are left</span></span><br><span class="line">    activeTragedyParams: isNextRound</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : isStumblingStep</span><br><span class="line">        ? newStumblingSteps</span><br><span class="line">        : state.activeTragedyParams,</span><br><span class="line">    lastDiceRoll: roll,</span><br><span class="line">    <span class="comment">// since handling new monsters is whole lot of a different</span></span><br><span class="line">    <span class="comment">// complexity we separate it into it's own action and reuse</span></span><br><span class="line">    <span class="comment">// the resulting monster prop</span></span><br><span class="line">    monsters: generateWave(monsterRollState, isNextRound).monsters,</span><br><span class="line">    <span class="comment">// depending on whether we passed the last tile we accordingly</span></span><br><span class="line">    <span class="comment">// update the players position</span></span><br><span class="line">    players: [</span><br><span class="line">      &#123;</span><br><span class="line">        ...state.players[<span class="number">0</span>],</span><br><span class="line">        currentTileId: newPosition &gt; state.tiles.length - <span class="number">1</span></span><br><span class="line">          ? state.tiles[<span class="built_in">Math</span>.abs(newPosition - state.tiles.length)].id</span><br><span class="line">          : state.tiles[newPosition].id</span><br><span class="line">      &#125; <span class="keyword">as</span> Player</span><br><span class="line">    ],</span><br><span class="line">    purchaseInProgress: <span class="literal">undefined</span>,</span><br><span class="line">    <span class="comment">// calculate the new resources, by respecting harvested resources</span></span><br><span class="line">    <span class="comment">// from existing tile buildings</span></span><br><span class="line">    resources: isNextRound</span><br><span class="line">      ? gatherResources(state).resources</span><br><span class="line">      : state.resources,</span><br><span class="line">    round: isNextRound</span><br><span class="line">      ? state.round + <span class="number">1</span></span><br><span class="line">      : state.round,</span><br><span class="line">    <span class="comment">// and update the new stats, after the result of the monster rolls</span></span><br><span class="line">    stats: monsterRollState.stats,</span><br><span class="line">  &#125;, isNextRound);</span><br></pre></td></tr></table></figure>
<p>With this approach, you can mix and match your resulting state, based on different sub-states, while still only emitting one single new state. That is especially important since we want to have easier means to time travel through our dice rolls using the Redux DevTools, as explained a bit later.</p>
<h2 id="Persisting-and-rehydrating-the-game-state"><a href="#Persisting-and-rehydrating-the-game-state" class="headerlink" title="Persisting and rehydrating the game state"></a>Persisting and rehydrating the game state</h2><p>It was already mentioned that Enforted is a pure client-side game, without the need for any kind of backend. While this has advantages like being a great target for an offline PWA, it also has an immediate downside. There is no session or game state saving and persisting. To overcome this issue, we can make use of the browsers local storage. Fortunately, the Aurelia Store plugin comes with a nifty helper out of the box.</p>
<p>In the constructor of <a href="https://github.com/zewa666/enforted/blob/master/src/app.ts" target="_blank" rel="noopener">app.ts</a> all the magic happens, as depicted in the following code listing. First, we’ll create a subscription after the first emitted state, to avoid the initial state propagation, and subscribe exactly for one iteration. We’ll then register the stores <code>localStorageMiddleware</code> and place it after the processing queue, by making use of a custom storage key. This middleware makes sure to persist the emitted state in the local storage, whenever a new action is emitted. And this is exactly the reason why we need to ditch the initial stream item as we’d otherwise immediately persist the original initial state, thus auto-negating the persisting feature.</p>
<p>After the action registrations are done we can safely dispatch <code>rehydrateFromLocalStorage</code> to load the persisted state into the store.</p>
<figure class="highlight typescript"><figcaption><span>Using the stores localstorage action and middleware action</span><a href="https://github.com/zewa666/enforted/blob/master/src/app.ts#L37-L72" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> store: Store&lt;State&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> dialogService: DialogService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> ea: EventAggregator</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store</span><br><span class="line">      .state</span><br><span class="line">      .pipe(</span><br><span class="line">        skip(<span class="number">1</span>),</span><br><span class="line">        take(<span class="number">1</span>)</span><br><span class="line">      ).subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.store.registerMiddleware(</span><br><span class="line">          localStorageMiddleware,</span><br><span class="line">          MiddlewarePlacement.After,</span><br><span class="line">          &#123; key: LOCALSTORAGE_SAVE_KEY &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"Rehydrate from localstorage"</span>, rehydrateFromLocalStorage);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"roll the dice"</span>, rollDice);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"open the purchase panel"</span>, openPurchaseForTile);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"close the purchase panel"</span>, closePurchasePanel);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"buy a tile building"</span>, buyBuilding);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"destroy a tile building"</span>, destroyBuilding);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragedy] sacrifice resources"</span>, sacrificeResources);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragedy] raging fire"</span>, ragingFire);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragedy] the forgotten equipment"</span>, forgottenEquipment);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragedy] a defiled altar"</span>, defiledAltar);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragedy] paused resource production"</span>, pausedResourceProduction);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragey] collapsed mines"</span>, collapsedMines);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"[tragey] stumbling steps"</span>, stumblingSteps);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"buy fortress building"</span>, buyFortressBuilding);</span><br><span class="line">    <span class="keyword">this</span>.store.registerAction(<span class="string">"reinforce tile building"</span>, reinforceTileBuilding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.store.dispatch(rehydrateFromLocalStorage, LOCALSTORAGE_SAVE_KEY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>And that’s all that’s needed to create an auto-save behavior for the game. Now we’re not done yet here, as if you remember, the game typically starts with a <code>start-screen</code> first, asking for the player’s name. When we re-hydrate an already saved game state though, we’d like to ditch this and go straight away to the game board.</p>
<p>Remember when we said that store actions are just pure functions which you can compose? Well, we can also use the pre-made <code>rehydrateFromLocalStorage</code> to get hold of the state before even launching the game inside the <code>main.ts</code> file. Inside the function <code>configure</code>, we’ll grab the persisted state - note that we can pass an empty object as the state since we’re not interested in the usual state emitting behavior - and use that to decide where the root of our app is going to be.</p>
<figure class="highlight typescript"><figcaption><span>Using the stores localstorage action and middleware action</span><a href="https://github.com/zewa666/enforted/blob/master/src/main.ts#L75-L76" target="_blank" rel="noopener">See the source on GitHub</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> storage = rehydrateFromLocalStorage(&#123;&#125;, LOCALSTORAGE_SAVE_KEY) <span class="keyword">as</span> State;</span><br><span class="line">aurelia.setRoot(storage.gameStarted ? <span class="string">"./app"</span> : <span class="string">"./start-screen"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Cheating-like-a-pro-with-Redux-DevTools"><a href="#Cheating-like-a-pro-with-Redux-DevTools" class="headerlink" title="Cheating like a pro with Redux DevTools"></a>Cheating like a pro with Redux DevTools</h2><p>Sometimes pictures can describe more than 1000 words, and now just imagine multiple of those in high-frame rates ;) So instead of too much talking, just take a look at the video below, to get an idea how you can use the Redux DevTools extension to undo dice rolls and go a different path. It’s a nifty feature, especially during development and a manual exploratory phase.</p>
<iframe src="/content/images/2020/02/devtools_cheating.mp4" width="100%" height="300" frameborder="0" allowfullscreen></iframe>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>As mentioned in the intro, this is the first article of the Enforted series and I hope you enjoyed reading so far. Working with the Aurelia Store plugin is a joy and you should give it a try on your next fun project. Make sure to let me know how it worked out or any other questions you have about this article in the comments below.</p>

      
      <script src="https://utteranc.es/client.js" repo="zewa666/zewa666.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" label="Blog comment" async>
      </script>
      
    </section>
    <footer class="post-footer">
      
      <section class="author">
    <h4>Vildan Softic</h4>
    <p>Vildan Softic is a consultant and software developer from Austria. He is passionate about developing Single Page Applications, grinding LOB Apps with .NET and is pushing towards Node.JS development.</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://pragmatic-coder.net/enforted-state-management/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://pragmatic-coder.net/enforted-state-management/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://pragmatic-coder.net/enforted-state-management/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
      
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/enforted-all-things-ui/">
        ← Enforted - Building a game with style(sheets)
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/enforted-the-beginning/">
        Enforted - A board game built with Aurelia →
    </a>
    
</nav>
</main>

  
<footer class="site-footer">
  
  <div class="inner">
     <a href="/impressum-legal-notice.html">Impressum / Legal notice</a>
     <section class="copyright"><a href="http://pragmatic-coder.net">Pragmatic Coder</a> © 2018 This page is using Google Analytics, in order to opt-out click 
      <a onclick="alert('Google Analytics has been deactivated');" href="javascript:gaOptout()">here</a></section>
     <section class="poweredby">Blog picture <a href="http://creativecommons.org/licenses/by-sa/2.0/">creative commons licensed ( BY-SA )</a> 
      <a title="Pragmatic phone operator" href="https://www.flickr.com/photos/2ni/6779068688">Pragmatic phone operator</a> - <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>






</body>
</html>
